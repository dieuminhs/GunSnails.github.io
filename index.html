<!DOCTYPE html>
<html>

<body>
    <audio id="buttonOverAudio">
    <source src = "sound/buttonOver.mp3" type = "audio/mpeg">
    </audio>
    <label for="angle">Enter Angle:</label>
    <input type="number" id="angle" name="angle">
    <label for="power">Enter Power:</label>
    <input type="number" id="power" name="power">
    <label for="wind">Enter Wind Power:</label>
    <input type="number" id="wind" name="wind"><br><br>
    <script src="bump.js"></script>
    <script src="pixi.min.js"></script>
    <script src="pixi-filters.js"></script>




    <style>
        * {
            padding: 0;
            margin: 0
        }
    </style>
    <script type="text/javascript">
        var renderer = new PIXI.Renderer();

        var app = new PIXI.Application();

        var buttonOverAudio = document.getElementById("buttonOverAudio");

        // Ticker render bullet per frame
        const ticker = new PIXI.ticker.Ticker();
        ticker.stop();
        // t - TimePassed
        let t;
        // v0 - Power, g - Gravity, a - WindPower
        var v0, angle, g, a;


        var spriteBullet;
        var tree;
        let sheet, sheet2;

        // Brightness adjustion matrix for filter
        var brightness = 0.2;
        var b = (brightness || 0) + 1;
        var _filter = [
            b, 0, 0, 0, 0,
            0, b, 0, 0, 0,
            0, 0, b, 0, 0,
            0, 0, 0, 1, 0
        ];

        var filter = new PIXI.filters.ColorMatrixFilter();
        filter.matrix = _filter;

        const outlineFilterBlue = new PIXI.filters.OutlineFilter(2, 0x000000);




        //Add the canvas that Pixi automatically created for you to the HTML document

        document.body.appendChild(app.view);

        // Resize the renderer to fit the window screen
        app.renderer.view.style.position = "absolute";
        app.renderer.view.style.display = "block";
        app.renderer.autoResize = true;
        app.renderer.resize(window.innerWidth, window.innerHeight);

        // create the root of the scene graph




        // create a background
        var background = PIXI.Sprite.fromImage('image.jpg');
        background.width = app.renderer.width;
        background.height = app.renderer.height;

        // add background to menuScene
        app.stage.addChild(background);

        // Load các sprite ảnh từ spritesheet bằng file json
        var textureButton;
        var textureBullet = PIXI.Texture.fromImage('image/Bullet.png');
        PIXI.Loader.shared.add("image/spriteSheet.json").load(loadedImages);


        function loadedImages() {
            sheet2 = PIXI.Loader.shared.resources["image/spriteSheet.json"].spritesheet;
            textureButton = [
                sheet2.textures["Play.png"],
                sheet2.textures["Options.png"],
                sheet2.textures["Exit.jpg"]
            ];
            // Add buttons to the Scene
            addButtons();
            tree = new PIXI.Sprite(sheet2.textures["Tree.png"]);
            console.log("Sprite Loaded!");

            loadAnim();
        }



        function loadAnim() {


            // Load các sprite ảnh tạo nên Animation từ spritesheet bằng file json

            PIXI.Loader.shared.add("image/explosionSheet.json").load(setup);


            function setup() {
                sheet = PIXI.Loader.shared.resources["image/explosionSheet.json"].spritesheet;
            }

            console.log(tree.width);
            tree.anchor.set(0.5);
            tree.scale.x = 0.5;
            tree.scale.y = 0.5;
            tree.x = 0.8 * background.width;
            tree.y = 0.8 * background.height;
            tree.filters = [outlineFilterBlue];
            app.stage.addChild(tree);


            console.log("Animation Loaded!");
        }



        // Create button array
        var buttons = [];

        // Create name array to specify buttons
        var name = [
            "Play",
            "Options",
            "Exit"
        ]

        // Create position array for buttons
        var buttonPositions = [
            background.width / 2, background.height / 5,
            background.width / 2, 2 * background.height / 5,
            background.width / 2, 3 * background.height / 5
        ];

        // Do something when a button is clicked
        var shootBullet = function() {

            spriteBullet = new PIXI.Sprite(textureBullet);
            spriteBullet.anchor.set(0.5);
            spriteBullet.x = 0.1 * background.width;
            spriteBullet.y = 0.8 * background.height;
            spriteBullet.scale.x = 0.2;
            spriteBullet.scale.y = 0.2;
            app.stage.addChild(spriteBullet);
            t = 0;
            a = document.getElementById("wind").value;
            v0 = document.getElementById("power").value,
                angle = Math.PI / 180 * document.getElementById("angle").value,
                g = 10;
            ticker.start();

            app.render();
            console.log(app.x);
            console.log(app.y);
            var array = app.renderer.extract.pixels(tree);


            console.log(array);
            console.log(app.renderer.width);
            console.log(app.renderer.height);


            var black = [];

            for (i = 0; i < array.length / 4; i++) {
                if (array[4 * i] == 0 && array[4 * i + 1] == 0 && array[4 * i + 2] == 0) {
                    black[i] = 1;
                } else {
                    black[i] = 0;
                }
            }


            console.log(black);
            var result = array.filter(color => color == 0);

            console.log(result);
        };






        function onButtonDown() {
            this.isDown = true;
            this.filters = null;

        }

        function onButtonUp() {
            this.isDown = false;
            if (this.isOver) {
                this.filters = [filter];
            } else {

            }

        }

        function onButtonOver() {
            this.isOver = true;
            if (this.isDown) {
                return;
            }
            // Adjust buttonOver texture
            this.filters = [filter];

            buttonOverAudio.play();
        }

        function onButtonOut() {
            this.isOver = false;
            if (this.isDown) {
                return;
            }
            // Adjust buttonOut texture
            this.filters = null;

        }


        // Adjust bullet position per frame
        ticker.add((deltaTime) => {

            var b = new Bump(PIXI);
            vx = v0 * Math.cos(angle) + a * t / 10;
            vy = v0 * Math.sin(angle) - g * t / 10;

            spriteBullet.x += vx;
            spriteBullet.y -= vy;

            t += 0.2;

            if (b.hit(spriteBullet, tree)) {
                explosion = new PIXI.AnimatedSprite(sheet.animations["explosion3"]);
                explosion.anchor.set(0.5);
                explosion.visible = true;
                explosion.x = spriteBullet.x;
                explosion.y = spriteBullet.y;
                explosion.loop = false;
                explosion.animationSpeed = 0.5;

                app.stage.addChild(explosion);
                explosion.play();

                explosion.onComplete = function() {
                    explosion.destroy();
                }
                spriteBullet.destroy();
                ticker.stop();
            }

        });

        function addButtons() {
            for (var i = 0; i < 3; i++) {
                var button = new PIXI.Sprite(textureButton[i]);
                button.buttonMode = true;

                button.anchor.set(0.5);
                button.name = name[i];
                button.position.x = buttonPositions[i * 2];
                button.position.y = buttonPositions[i * 2 + 1];

                // make the button interactive...
                button.interactive = true;


                button
                // set the mousedown and touchstart callback...
                    .on('mousedown', onButtonDown)
                    .on('touchstart', onButtonDown)

                // set the mouseup and touchend callback...
                .on('mouseup', onButtonUp)
                    .on('touchend', onButtonUp)
                    .on('mouseupoutside', onButtonUp)
                    .on('touchendoutside', onButtonUp)

                // set the mouseover callback...
                .on('mouseover', onButtonOver)

                // set the mouseout callback...
                .on('mouseout', onButtonOut)


                // you can also listen to click and tap events :
                //.on('click', shootBullet)

                button.tap = shootBullet;
                button.click = shootBullet;
                // add it to the app.stage
                app.stage.addChild(button);

                // add button to array
                buttons.push(button);
            }
        }
    </script>

</body>

</html>